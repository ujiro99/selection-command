# Sentry 導入設計

## 機能要件

- 本拡張機能へ Sentry を導入し、エラーをsentryに送信する。
- 以下の情報を送信する。
  - エラーの発生場所
  - エラーの内容
- 読み込む対象の機能は、以下の通り。
  - content_script
  - background_script
  - options_page
- デバッグビルドの場合hは、Sentryの初期化を行わない。

## 非機能要件

- Sentryの初期化は、ページの読み込み時に行う。
- Sentryの動作により、ページ本体や拡張機能の動作に影響を与えないようにする。

## 制約

- ユーザー情報は送信しない。
- ユーザーの実行環境についての情報は、個人を特定できない範囲で送信する。
- 設定情報の、UserSettings.pageRule で動作非対象(popupEnabled = 'Disabled')となっているページでは、Sentryの初期化自体を行わない。

## 実装設計

### アーキテクチャ構成

#### 1. コンテキスト別初期化

- **Service Worker (background_script)**: 拡張機能のライフサイクル管理とバックグラウンド処理のエラー監視
- **Content Script**: Webページ上でのUI操作とDOM操作のエラー監視
- **Options Page**: 設定画面でのフォーム処理とユーザー操作のエラー監視

#### 2. 初期化条件の制御

- **デバッグビルド判定**: `isDebug`フラグによる初期化スキップ
- **PageRule判定**: `chrome.storage.sync.get()`でページ固有の設定を確認
  - STORAGE_KEY.USER の `pageRule.popupEnabled` が `Disabled` の場合、初期化をスキップ
- **遅延初期化**: パフォーマンス影響を最小化するため必要時のみ初期化

#### 3. プライバシー保護機能

- **URL情報の制限**: パスのみ保持、パラメータとハッシュ値を除去
- **個人識別情報の除外**: ユーザー固有の設定値や入力内容を送信対象外とする
- **環境情報の制限**: ブラウザバージョン、OS情報のみに限定

#### 4. エラーハンドリング範囲

- **非同期処理エラー**: Promise rejection、async/awaitの例外
- **Chrome Extension APIエラー**: 権限不足、API呼び出し失敗
- **UI操作エラー**: フォームバリデーション、DOM操作の失敗

### パフォーマンス考慮事項

#### 1. 初期化の最適化

- 拡張機能の起動時間への影響を最小化
- 必要時のみSentryクライアントを生成
- 設定読み込み処理の非同期化

#### 2. 送信制御

- エラー発生時のバッチ処理
- 送信頻度の制限機能
- ネットワーク帯域への配慮

#### 3. メモリ使用量の最適化

- 不要なintegrationの除外
- スタックトレース情報の制限
- 古いエラー情報の自動削除

### セキュリティ考慮事項

- 機密性の高い設定値の除外
- ユーザーの入力内容の非送信
- 認証情報やAPIキーの保護

## テスト設計

### 単体テスト項目

#### ST-01: 初期化制御テスト

- **ST-01-a**: デバッグビルド時にSentry初期化がスキップされること
- **ST-01-b**: pageRule設定でpopupEnabled=Disabledの場合に初期化がスキップされること
- **ST-01-c**: 正常条件下でSentryクライアントが適切に初期化されること

#### ST-02: エラーキャプチャテスト

- **ST-02-a**: 同期処理での例外が正しくキャプチャされること
- **ST-02-b**: 非同期処理での例外が正しくキャプチャされること

#### ST-03: プライバシー保護テスト

- **ST-03**: URL情報からパラメータが除去されること

#### ST-04: パフォーマンステスト

- **ST-04-a**: Sentry初期化が拡張機能起動時間に与える影響が許容範囲内であること
- **ST-04-b**: エラー送信処理がUIの応答性に影響を与えないこと

#### ST-05: 設定管理テスト

- **ST-05-a**: chrome.storage.sync.get() で STORAGE_KEY.USER からの設定取得が正しく動作すること
- **ST-05-b**: 設定変更時にSentry初期化状態が適切に更新されること
- **ST-05-c**: 無効な設定値に対して適切なフォールバック処理が行われること

### 統合テスト項目

#### IT-01: コンテキスト間連携テスト

- **IT-01-a**: Service Worker、Content Script、Options Page間でのエラー情報の整合性
- **IT-01-b**: 各コンテキストでの初期化条件の独立性確認
