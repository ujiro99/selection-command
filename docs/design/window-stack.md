# Window Stack の設計書

## 機能要件

- ポップアップウィンドウ(以下、ウィンドウ)は、自分より後ろにあるウィンドウにフォーカスが移った場合、自動的にクローズされる
- このウィンドウの前後関係を、スタック構造で管理する

### 基本動作

- あるウィンドウ(A)から新しいウィンドウ(B)が開かれた場合、新しいウィンドウ(A)はウィンドウ(B)の前に配置される
  - [A] -> [B]
- ウィンドウ(B)からウィンドウ(A)にフォーカスが移った場合、ウィンドウ(B)はクローズされる
  - [A] (Bはクローズ)
- ウィンドウ(B)からさらに新しいウィンドウ(C)が開かれた場合、ウィンドウ(B)はウィンドウ(C)の前に配置される
  - [A] -> [B] -> [C]
- この時、ウィンドウ(C)から一番後ろのウィンドウ(A)にフォーカスが移った場合、そのウィンドウより前にあるウィンドウ(B, C)はすべてクローズされる
  - [A] (B, Cはクローズ)

### ウィンドウのレイヤーについて

- ウィンドウは複数同時に開くことができ、これらの一群を層(レイヤー)として扱う
  - [A] -> [B, C] (レイヤーが生成される)
- 同じレイヤー間では、ウィンドウの前後関係は考慮しない。よって、同じレイヤーにフォーカスが移っても、ポップアップウィンドウはクローズされない
  - [A] -> [B, C] (BからCにフォーカスが移っても、Bはクローズされない)
- レイヤーは、ウィンドウが開かれた順に積み重なっていく
  - [A] -> [B, C] -> [D] (DはB, Cの上に積み重なる)
- レイヤー間では、ウィンドウの前後関係を考慮する。よって、あるレイヤーから後ろレイヤーにフォーカスが移った場合、前のレイヤーにあったすべてのウィンドウはクローズされる
  - [A] -> [B, C] -> [D, E, F] (D, E, Fのレイヤーが生成された状態)
  - [A] -> [B, C] (DからBにフォーカスが移った場合、D, E, Fはすべてクローズされる)
- レイヤーは、レイヤー内のすべてのウィンドウがクローズされた場合にのみ消滅する
  - [A] -> [B, C] (B, Cのレイヤーが生成された状態)
  - [A] -> [B] (Cがクローズされた状態)
  - [A] (Bがクローズされた場合、レイヤーは消滅する)
- 複数レイヤーをまたいでフォーカスが移った場合、移動先のレイヤーより前にあるすべてのレイヤーはクローズされる
  - [A] -> [B, C] -> [D, E, F] (D, E, Fのレイヤーが生成された状態)
  - [A] (FからAにフォーカスが移った場合、B, C, D, E, Fはすべてクローズされる)

## 詳細設計

### WindowStackManagerクラス

ウィンドウスタックの論理的な管理を担当するクラス。ServiceWorkerでの状態揮発に対応するため、backgroundData.tsと連携してセッション永続化を行う。

#### 責任分離

- **WindowStackManager**: スタック構造の管理と論理処理のみ
- **呼び出し元（background_script.ts）**: 実際のChromeウィンドウの操作（削除等）

#### クラス設計

```typescript
class WindowStackManager {
  // BgDataと連携してスタック状態を永続化
  private static async saveStack(stack: WindowLayer[]): Promise<void>;
  private static async loadStack(): Promise<WindowLayer[]>;

  // ウィンドウ追加（新しいレイヤーまたは既存レイヤーに）
  static async addWindow(
    window: WindowType,
    parentWindowId?: number,
  ): Promise<void>;

  // ウィンドウ削除
  static async removeWindow(windowId: number): Promise<void>;

  // フォーカス変更時のクローズ対象を特定
  static async getWindowsToClose(
    focusedWindowId: number,
  ): Promise<WindowType[]>;

  // スタック状態の取得
  static async getStack(): Promise<WindowLayer[]>;

  // 空になったレイヤーをクリーンアップ
  static async cleanupEmptyLayers(): Promise<void>;
}
```

#### 主要な動作仕様

1. **ウィンドウ追加時の処理**
   - `parentWindowId`が指定された場合、該当するレイヤーを特定
   - 該当レイヤーが見つかった場合は、そのレイヤーの次に新しいレイヤーを作成してウィンドウを追加
   - 該当レイヤーが見つからない場合は、スタックの最後に新しいレイヤーを作成してウィンドウを追加
   - 既存レイヤーへのウィンドウ追加は行わない（常に新しいレイヤーを作成）

2. **フォーカス変更時のクローズ判定**
   - フォーカスされたウィンドウのレイヤーインデックスを特定
   - そのレイヤーより後（前面）にあるすべてのレイヤーのウィンドウをクローズ対象として返却
   - フォーカスされたウィンドウがスタック外の場合は、すべてのウィンドウをクローズ対象とする

3. **状態永続化**
   - すべてのスタック変更操作後、自動的にBgDataにスタック状態を保存
   - ServiceWorker再起動時も、BgDataからスタック状態を復元可能

#### ServiceWorker対応

- すべてのメソッドを非同期化（BgDataとの連携のため）
- インスタンス変数は持たず、常にBgDataから最新状態を取得
- メソッド実行時にBgDataから状態をロード、処理後に保存

### backgroundData.tsとの連携

既存の`windowStack`プロパティを活用し、WindowStackManagerからの更新を受け取る。

```typescript
// WindowStackManagerから呼び出される更新処理
BgData.update((data) => ({ windowStack: newStack }));
```

## ユニットテスト設計

### テストファイル構成

```
packages/extension/src/services/windowStackManager.test.ts
```

### テストケース一覧

#### 基本機能テスト

1. **ウィンドウ追加テスト**
   - 空のスタックに初回ウィンドウを追加
   - 既存ウィンドウから新しいウィンドウを追加（新しいレイヤー作成）
   - parentWindowIdが見つからない場合の新しいレイヤー追加

2. **ウィンドウ削除テスト**
   - 手動によるウィンドウ削除（レイヤー内に他のウィンドウが残存）
   - 手動によるレイヤー内全ウィンドウの削除（レイヤー消滅）
   - 存在しないウィンドウの削除（エラーハンドリング）

3. **フォーカス変更時のクローズ判定テスト**
   - 同じレイヤー内でのフォーカス移動（クローズ対象なし）
   - 後ろのレイヤーへのフォーカス移動（前面レイヤーすべてクローズ）
   - 複数レイヤーを跨いだフォーカス移動（フォーカス位置より前面のレイヤーすべてクローズ）
   - スタック外ウィンドウへのフォーカス移動（全ウィンドウクローズ）

#### レイヤー管理テスト

4. **レイヤー構造テスト**
   - 単一レイヤーの管理
   - 複数レイヤーの順序管理
   - レイヤーの自動クリーンアップ

5. **複合シナリオテスト**
   - [A] -> [B] -> [C] 構造での各種フォーカス移動
   - [A] -> [B, C] -> [D, E, F] 構造でのフォーカス変更によるレイヤー単位のクローズ
   - 手動ウィンドウ削除とフォーカス変更の組み合わせ

#### ServiceWorker対応テスト

6. **永続化テスト**
   - スタック状態の保存・復元
   - BgDataとの連携動作確認
   - 状態の整合性保証

### テストデータ構造

```typescript
// テスト用ダミーウィンドウ
const createTestWindow = (id: number, commandId: string, srcWindowId: number): WindowType => ({
  id,
  commandId,
  srcWindowId
})

// テストシナリオの期待値定義
const testScenarios = [
  {
    description: "基本的なスタック操作",
    initialStack: [],
    operations: [...],
    expectedStack: [...],
    expectedCloseTargets: [...]
  }
  // ...
]
```

### モック対象

- `BgData.get()`, `BgData.update()` - スタック状態の取得・更新
- 必要に応じてChrome Storage API関連（BgData経由で使用される）
